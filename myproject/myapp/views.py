# -*- coding: utf-8 -*-
from django.shortcuts import render
from django.template import RequestContext
from django.http import HttpResponseRedirect
from django.core.urlresolvers import reverse
from myproject.myapp.models import Document
from myproject.myapp.models import Path
from myproject.myapp.forms import DocumentForm
from django.shortcuts import render
from django.conf import settings
import subprocess
import os.path
import glob
import os
from json2html import *
import json





def upload(request):
    # Handle file upload
    if request.method == 'POST':
        form = DocumentForm(request.POST, request.FILES)
        if form.is_valid():
            newdoc = Document(docfile=request.FILES['docfile'])
            newdoc.save()
            my_file = '/home/fernando/Desktop/myproject/media/samples/'+request.FILES['docfile'].name
            pathtofile = my_file.encode('ascii','ignore')
            ##subprocess.call('cuckoo submit '+my_file, shell=True)
            #cmd = '.'+os.path.join(settings.BASE_DIR,'myproject/myapp/submitsample.sh')+' '+pathtofile
            subprocess.call('/home/fernando/Desktop/myproject/myproject/myapp/submitsample.sh '+pathtofile, shell=True)
                


            """list_of_files = glob.glob('/home/fernando/.cuckoo/storage/analyses')
            latest_file = max(list_of_files, key=os.path.getctime)
            Path(pathto=os.path.abspath(latest_file))
            with open('/home/fernando/.cuckoo/storage/analyses/latest/reports/report.json') as data_file:
                data = json.loads(data_file)
                Path(idsha256=data[target][file][sha256])
                Path(name=data[target][file][name])
            """

            # Redirect to the document list after POST
            #return HttpResponseRedirect(reverse('upload'))
    else:
        form = DocumentForm()  # A empty, unbound form

    # Load documents for the list page
    documents = Document.objects.all()

    # Render list page with the documents and the form
    return render(request,'upload.html',{'documents': documents, 'form': form})
def list(request):
    
    return render(request,'list.html')
    
def index(request):
    return render(request,'index.html')

def search(request):
    return render(request,'index.html')

def dashboard(request):
    with open('/home/fernando/.cuckoo/storage/analyses/latest/reports/report.json') as data_file:
        data=json.load(data_file)
        info=data['target']['file']
        analisysinfo=data['debug']['log']
        networkudp=data['network']['udp']
        networktcp=data['network']['tcp']
        networkdns=data['network']['dns']
        networkdomains=data['network']['domains']
        infohtml=json2html.convert(json = info)
        analisysinfohtml=json2html.convert(json = analisysinfo)
        networkudphtml=json2html.convert(json = networkudp)
        networktcphtml=json2html.convert(json = networktcp)
        networkdnshtml=json2html.convert(json = networkdns)
        networkdomainshtml=json2html.convert(json = networkdomains)
        context={
        'infohtml': infohtml, 
        'analisysinfohtml': analisysinfohtml, 
        'networkudphtml': networkudphtml, 
        'networktcphtml': networktcphtml, 
        'networkdnshtml': networkdnshtml, 
        'networkdomainshtml': networkdomainshtml,
        }

    return render(request, 'analisys.html', context)



