{%include "head.html" %}


<script type="text/javascript" src="/media/js/d3.v2.js"></script>

    <script type="text/javascript">

      d3.select(self.frameElement).style("height", "1800px");
      d3.select(self.frameElement).style("width", "1200px");

      // This example draws a Radial Hub and Spoke Graph on a page with
      // multiple HTML layout constructs.
      // Created by Frank Guerino : "http://www.guerino.net"

      // Data Used for this example...

      var focalNod = {{ datafocal|safe }};

      var focalNodeID = focalNod.id;

      var nodeSet = {{ datanodes|safe }};

      var linkSet = {{ datalinks|safe }};


      function drawCluster( drawingName, focalNode, nodeSet, linkSet, selectString, colors ) {

        // drawingName => A unique drawing identifier that has no spaces, no "." and no "#" characters.
        // focalNode => Primary Node of Context.
        // nodeSet => Set of nodes and their relevant data.
        // linkSet => Set of links and their relevant data.
        // selectString => String that allows you to pass in
        //           a D3 select string.
        // colors => String to set color scale.  Values can be...
        //           => "colorScale10"
        //           => "colorScale20"
        //           => "colorScale20b"
        //           => "colorScale20c"
        // margin => Integer margin offset value.
        // outerRadius => Integer outer radius value.
        // innerRadius => Integer inner radius value.
        // sortArcs => Controls sorting of Arcs by value.
        //              0 = No Sort.  Maintain original order.
        //              1 = Sort by arc value size.

        // Color Scale Handling...
        var colorScale = d3.scale.category20c();
        switch (colors)
        {
          case "colorScale10":
            colorScale = d3.scale.category10();
            break;
          case "colorScale20":
            colorScale = d3.scale.category20();
            break;
          case "colorScale20b":
            colorScale = d3.scale.category20b();
            break;
          case "colorScale20c":
            colorScale = d3.scale.category20c();
            break;
          default:
            colorScale = d3.scale.category20c();
        };
  
        var width = 700;
        var height = 600;
        var centerNodeSize = 60;
        var nodeSize = 10;
        var color_hash = [];

        var typeMouseOver = function() {

          var thisObject = d3.select(this);
          var typeValue = thisObject.attr("type_value");
          var strippedTypeValue = typeValue.replace(/ /g, "_");

          var legendBulletSelector = "." + "legendBullet-" + strippedTypeValue;
          var selectedBullet = d3.selectAll(legendBulletSelector);
          //document.writeln(legendBulletSelector);
          selectedBullet.style("fill", "Maroon");
      selectedBullet.attr("r", 1.2*6);

          var legendTextSelector = "." + "legendText-" + strippedTypeValue;
          var selectedLegendText = d3.selectAll(legendTextSelector);
          //document.writeln(legendBulletSelector);
          selectedLegendText.style("font", "bold 14px Arial")
          selectedLegendText.style("fill", "Maroon");

          var nodeTextSelector = "." + "nodeText-" + strippedTypeValue;
          var selectedNodeText = d3.selectAll(nodeTextSelector);
          //document.writeln(pie3SliceSelector);
          selectedNodeText.style("font", "bold 16px Arial")
          selectedNodeText.style("fill", "Maroon");

          var nodeCircleSelector = "." + "nodeCircle-" + strippedTypeValue;
          var selectedCircle = d3.selectAll(nodeCircleSelector);
          //document.writeln(nodeCircleSelector);
          selectedCircle.style("fill", "Maroon");
          selectedCircle.style("stroke", "Maroon");
      selectedCircle.attr("r", 1.2*nodeSize);

          var focalNodeCircleSelector = "." + "focalNodeCircle";
          var selectedFocalNodeCircle = d3.selectAll(focalNodeCircleSelector);
          //document.writeln(focalNodeCircleSelector);
          var focalNodeType = selectedFocalNodeCircle.attr("type_value");
          if (typeValue == focalNodeType){
            selectedFocalNodeCircle.style("stroke", "Maroon");
            selectedFocalNodeCircle.style("fill", "White");
          };

          var focalNodeTextSelector = "." + "focalNodeText";
          var selectedFocalNodeText = d3.selectAll(focalNodeTextSelector);
          var focalNodeTextType = selectedFocalNodeText.attr("type_value");
          //document.writeln(pie3SliceSelector);
          if (typeValue == focalNodeTextType) {
            selectedFocalNodeText.style("fill", "Maroon");
            selectedFocalNodeText.style("font", "bold 16px Arial")
          };

        };

        var typeMouseOut = function() {

          var thisObject = d3.select(this);
          var typeValue = thisObject.attr("type_value");
          var colorValue = thisObject.attr("color_value");
          var strippedTypeValue = typeValue.replace(/ /g, "_");

          var legendBulletSelector = "." + "legendBullet-" + strippedTypeValue;
          var selectedBullet = d3.selectAll(legendBulletSelector);
          //document.writeln(legendBulletSelector);
          selectedBullet.style("fill", colorValue);
      selectedBullet.attr("r", 6);

          var legendTextSelector = "." + "legendText-" + strippedTypeValue;
          var selectedLegendText = d3.selectAll(legendTextSelector);
          //document.writeln(legendBulletSelector);
          selectedLegendText.style("font", "normal 14px Arial")
          selectedLegendText.style("fill", "Black");

          var nodeTextSelector = "." + "nodeText-" + strippedTypeValue;
          var selectedNodeText = d3.selectAll(nodeTextSelector);
          //document.writeln(pie3SliceSelector);
          selectedNodeText.style("font", "normal 16px Arial")
          selectedNodeText.style("fill", "Blue");

          var nodeCircleSelector = "." + "nodeCircle-" + strippedTypeValue;
          var selectedCircle = d3.selectAll(nodeCircleSelector);
          //document.writeln(nodeCircleSelector);
          selectedCircle.style("fill", "White");
          selectedCircle.style("stroke", colorValue);
      selectedCircle.attr("r", nodeSize);

          var focalNodeCircleSelector = "." + "focalNodeCircle";
          var selectedFocalNodeCircle = d3.selectAll(focalNodeCircleSelector);
          //document.writeln(focalNodeCircleSelector);
          var focalNodeType = selectedFocalNodeCircle.attr("type_value");
          if (typeValue == focalNodeType){
            selectedFocalNodeCircle.style("stroke", colorValue);
            selectedFocalNodeCircle.style("fill", "White");
          };

          var focalNodeTextSelector = "." + "focalNodeText";
          var selectedFocalNodeText = d3.selectAll(focalNodeTextSelector);
          //document.writeln(pie3SliceSelector);
          selectedFocalNodeText.style("fill", "Blue");
          selectedFocalNodeText.style("font", "normal 14px Arial")

        };

        var nodeMouseOver = function() {

          var thisObject = d3.select(this);
          var typeValue = thisObject.attr("type_value");
          var colorValue = thisObject.attr("color_value");
          var strippedTypeValue = typeValue.replace(/ /g, "_");

          d3.select(this).select("circle").transition()
              .duration(250)
          .attr("r", function(d,i) { if(d.id==focalNodeID) {return 65;} else {return 15;} } );
      d3.select(this).select("text").transition()
              .duration(250)
          .style("font", "bold 20px Arial")
          .attr("fill", "red");

          var legendBulletSelector = "." + "legendBullet-" + strippedTypeValue;
          var selectedBullet = d3.selectAll(legendBulletSelector);
          //document.writeln(legendBulletSelector);
          selectedBullet.style("fill", "Maroon");
      selectedBullet.attr("r", 1.2*6);

          var legendTextSelector = "." + "legendText-" + strippedTypeValue;
          var selectedLegendText = d3.selectAll(legendTextSelector);
          //document.writeln(legendBulletSelector);
          selectedLegendText.style("font", "bold 14px Arial")
          selectedLegendText.style("fill", "Maroon");

        }

        var nodeMouseOut = function() {

          var thisObject = d3.select(this);
          var typeValue = thisObject.attr("type_value");
          var colorValue = thisObject.attr("color_value");
          var strippedTypeValue = typeValue.replace(/ /g, "_");

          d3.select(this).select("circle").transition()
              .duration(250)
          .attr("r", function(d,i) { if(d.id==focalNodeID) {return centerNodeSize;} else {return nodeSize;} } );
      d3.select(this).select("text").transition()
              .duration(250)
          .style("font", "normal 16px Arial")
          .attr("fill", function(d) { if (d.id==focalNodeID) {return "Red";} else {return "Blue";} });

          var legendBulletSelector = "." + "legendBullet-" + strippedTypeValue;
          var selectedBullet = d3.selectAll(legendBulletSelector);
          //document.writeln(legendBulletSelector);
          selectedBullet.style("fill", colorValue);
      selectedBullet.attr("r", 6);

          var legendTextSelector = "." + "legendText-" + strippedTypeValue;
          var selectedLegendText = d3.selectAll(legendTextSelector);
          //document.writeln(legendBulletSelector);
          selectedLegendText.style("font", "normal 14px Arial")
          selectedLegendText.style("fill", "Black");

        }

        // Create a hash that maps colors to types...
        nodeSet.forEach(function(d, i) {
        color_hash[d.type] = d.type;
          //document.writeln(color_hash[d.type]);
        });
        
    // Create a canvas...
        var svgCanvas = d3.select(selectString)
          .append("svg:svg")
            .attr("width", width)
        .attr("height", height)
          .append("svg:g")
            .attr("class", "focalNodeCanvas")
            .attr("transform", "translate(" + width/2 + "," + height/2 + ")")

        var node_hash = [];
        var type_hash = [];

        // Create a hash that allows access to each node by its id
        nodeSet.forEach(function(d, i) {
          node_hash[d.id] = d;
          type_hash[d.type] = d.type;
        });
      
        // Append the source object node and the target object node to each link records...
        linkSet.forEach(function(d, i) {
          d.source = node_hash[d.sourceId];
          d.target = node_hash[d.targetId];
          if (d.sourceId == focalNodeID)
        { d.direction = "OUT"; }
          else
        { d.direction = "IN"; }
        });

        // Create a force layout and bind Nodes and Links
        var force = d3.layout.force()
            .nodes(nodeSet)
            .links(linkSet)
            .charge(-1000)
        .gravity(.01)
        .friction(.2)
            .linkStrength(9)
            //.size([width/8, height/10])
            .linkDistance( function(d) { if (width < height) { return width*1/3; } else { return height*1/3 } } ) // Controls edge length
            .on("tick", tick)
            .start();

        // Draw lines for Links between Nodes
        var link = svgCanvas.selectAll(".gLink")
            .data(force.links())
          .enter().append("g")
            .attr("class", "gLink")
          .append("line")
            .attr("class", "link")
            .style("stroke", "Gray")
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        // Create Nodes
        var node = svgCanvas.selectAll(".node")
            .data(force.nodes())
          .enter().append("g")
            .attr("class", "node")
            .attr("type_value", function(d, i) { return d.type; })
            .attr("color_value", function(d, i) { return color_hash[d.type]; })
            .on("mouseover", nodeMouseOver)
            .on("mouseout", nodeMouseOut)
            .call(force.drag)
      .append("a")
        .attr("xlink:href", function(d) {return d.hlink; }); //return "Link malware"+d.hlink;

        // Append circles to Nodes
        node.append("circle")
            .attr("r", function(d) { if (d.id==focalNodeID) { return centerNodeSize; } else { return nodeSize; } } )
            .style("fill", "White") // Make the nodes hollow looking
            .attr("type_value", function(d, i) { return d.type; })
            .attr("color_value", function(d, i) { return color_hash[d.type];})
            .attr("class", function(d, i) {
              var str = d.type;
              var strippedString = str.replace(/ /g, "_")
          if (d.id==focalNodeID) { return "focalNodeCircle"; }
          else { return "nodeCircle-" + strippedString; }
            })
            .style("stroke-width", 5) // Give the node strokes some thickness
            .style("stroke", function(d) { if (d.id==focalNodeID) {return "Red";} else {return "Blue";} } ) // Node stroke colors CHANGE COLORS HERE
        .call(force.drag);

        // Append text to Nodes
        node.append("text")
            .attr("x", function(d) { if (d.id==focalNodeID) { return 0; } else {return 15;} } )
            .attr("y", function(d) { if (d.id==focalNodeID) { return 0; } else {return -10;} } )
        .attr("text-anchor", function(d) { if (d.id==focalNodeID) {return "middle";} else {return "start";} })
        .attr("font-family", "Arial, Helvetica, sans-serif")
            .style("font", "normal 12px Arial")
            .attr("fill", function(d) { if (d.id==focalNodeID) {return "Red";} else {return "Blue";} })
            .style("fill", function(d, i) { return color_hash[d]; })
            .attr("type_value", function(d, i) { return d.type; })
            .attr("color_value", function(d, i) { return color_hash[d.type]; })
            .attr("class", function(d, i) {
              var str = d.type;
              var strippedString = str.replace(/ /g, "_");
          if (d.id==focalNodeID) { return "focalNodeText"; }
          else { return "nodeText-" + strippedString; }
            })
            .attr("dy", ".35em")
            .text(function(d) { return d.name; });

        // Append text to Link edges
        var linkText = svgCanvas.selectAll(".gLink")
            .data(force.links())
          .append("text")
        .attr("font-family", "Arial, Helvetica, sans-serif")
        .attr("x", function(d) {
            if (d.target.x > d.source.x) { return (d.source.x + (d.target.x - d.source.x)/2); }
            else { return (d.target.x + (d.source.x - d.target.x)/2); }
        })
            .attr("y", function(d) {
            if (d.target.y > d.source.y) { return (d.source.y + (d.target.y - d.source.y)/2); }
            else { return (d.target.y + (d.source.y - d.target.y)/2); }
        })
        .attr("fill", "Blue")
            .style("font", "normal 12px Arial")
            .attr("dy", ".35em")
            .text(function(d) { return d.linkName; });


        function tick() {
          link
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });
      
          node
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

          linkText
        .attr("x", function(d) {
            if (d.target.x > d.source.x) { return (d.source.x + (d.target.x - d.source.x)/2); }
            else { return (d.target.x + (d.source.x - d.target.x)/2); }
        })
        .attr("y", function(d) {
            if (d.target.y > d.source.y) { return (d.source.y + (d.target.y - d.source.y)/2); }
            else { return (d.target.y + (d.source.y - d.target.y)/2); }
        });
        }

      };

    </script>


    <style type="text/css">
      svg {
        font: 10px sans-serif;
        display: block;
      }
    </style>

    <STYLE type="text/css">
      div.div_RootBody {
        position: relative;
        background: white;
        font: normal 12px Arial;
        font-family:Arial, Helvetica, sans-serif;
        color:Black;
        padding: 0px 1em;
        text-align:left;
      }
    </STYLE>
    <!--[if gt IE 7]>
      <style>body { overflow-y:scroll; } </style>
    <![endif]-->

  
    
    <!-- ... Your content goes here ... -->
    <h1>Full JSON Report: <a href="{% url 'myapp:report' %}">report.json</a>

    <h1>File info</h1>
    <div style="display: table;width: 100%">
    {% autoescape off %}
    {{ infohtml }}
    {% endautoescape %}
    </div>

    <h1>Virtual Machine</h1>
    <div style="display: table;width: 100%">
    {% autoescape off %}
    {{ machinestatushtml }}
    {% endautoescape %}
    </div>

    <h1>Analisys info</h1>
    <div style="display: table;width: 50%">
    {% autoescape off %}
    {{ analisysinfohtml }}
    {% endautoescape %}
    </div>
    
    <h1>UDP Connections</h1>
    <div style="display: table;width: 50%">
    <div class="div_RootBody" id="cluster_chart">
    <div class="chart"></div>
    </div>
    <script type="text/javascript">
      drawCluster("Drawing 1", focalNodeID, nodeSet, linkSet, "#cluster_chart .chart", "colorScale20");
    </script>
    {% autoescape off %}
    {{ networkudphtml }}
    {% endautoescape %}

    </div>

    <h1>TCP Connections</h1>
    <div style="display: table;width: 50%">
    {% autoescape off %}
    {{ networktcphtml }}
    {% endautoescape %}
    </div>
    
    <h1>DNS Connections</h1>
    <div style="display: table;width: 50%">
    {% autoescape off %}
    {{ networkdnshtml }}
    {% endautoescape %}
    </div>

    <h1>Domains</h1>
    <div style="display: table;width: 50%">
    {% autoescape off %}
    {{ networkdomainshtml }}
    {% endautoescape %}
    </div>  

</div>  
{%include "tail.html" %}